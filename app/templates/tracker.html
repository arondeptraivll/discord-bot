<!DOCTYPE html>
<html>
<head>
    <title>Redirecting...</title>
    <script src="https://fpjscdn.net/v3/rz2b58n2USn2d9B3bqD1"></script>
</head>
<body>
    <script>
        const targetUrl = "{{ target_url }}";
        const logUrl = "{{ log_url }}";

        // Hàm chuyển hướng, sẽ được gọi ngay lập tức
        function redirectToTarget() {
            window.location.replace(targetUrl);
        }

        // Hàm lấy fingerprint và gửi log, chạy ở chế độ "bắn và quên"
        function logAndContinue() {
            const fpPromise = FingerprintJS.load();

            (async () => {
                try {
                    const fp = await fpPromise;
                    const result = await fp.get({ extendedResult: true });
                    
                    const visitorData = {
                        visitorId: result.visitorId,
                        ip: result.ip,
                        browser: `${result.components.browserName.value} ${result.components.browserVersion.value}`,
                        os: `${result.components.os.value} ${result.components.osVersion.value}`,
                        device: result.components.device.value || 'Desktop',
                        screenResolution: `${result.components.screenResolution.value[0]}x${result.components.screenResolution.value[1]}`,
                        timezone: result.components.timezone.value,
                        language: result.components.language.value,
                        plugins: result.components.plugins.value.map(p => p.name).join(', ') || 'None'
                    };

                    // BẮN VÀ QUÊN: Không 'await' ở đây
                    // 'keepalive' cực kỳ quan trọng: nó báo trình duyệt giữ request này chạy
                    // ngay cả khi trang đã được chuyển đi.
                    fetch(logUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(visitorData),
                        keepalive: true 
                    });

                } catch (error) {
                    // Nếu lỗi cũng cố gắng gửi 1 bản log lỗi
                    fetch(logUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ error: "Failed to collect fingerprint." }),
                        keepalive: true
                    });
                }
            })(); // <-- Gọi hàm async ngay lập tức mà không chờ nó hoàn thành
        }

        // --- DÒNG LỆNH CHÍNH ---
        // 1. Chạy việc thu thập thông tin ở chế độ nền
        logAndContinue(); 
        // 2. Chuyển hướng người dùng đi ngay lập tức
        redirectToTarget();

    </script>
</body>
</html>
