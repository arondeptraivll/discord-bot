<!DOCTYPE html>
<html>
<head>
    <title>Redirecting...</title>
    <!-- 
        THAY ĐỔI QUAN TRỌNG:
        Chúng ta sẽ dùng một link CDN khác (từ jsDelivr) để tải phiên bản thư viện
        tương thích với thẻ <script> thông thường.
    -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
</head>
<body>
    <script>
        // Các biến này được truyền từ server Flask
        const targetUrl = "{{ target_url }}";
        const logUrl = "{{ log_url }}";

        // Hàm chuyển hướng người dùng đi ngay lập tức
        function redirectToTarget() {
            window.location.replace(targetUrl);
        }

        // Hàm lấy fingerprint và gửi log, chạy ở chế độ "bắn và quên" (fire-and-forget)
        function logAndContinue() {
            // Khởi tạo FingerprintJS
            // Lưu ý: Không còn fpPromise nữa, chúng ta sẽ gọi thẳng .load()
            FingerprintJS.load()
                .then(fp => fp.get({ extendedResult: true }))
                .then(result => {
                    // Trích xuất các thông tin cần thiết
                    const visitorData = {
                        visitorId: result.visitorId,
                        ip: result.ip, // IP từ client, server sẽ lấy IP chính xác hơn
                        browser: `${result.components.browserName.value} ${result.components.browserVersion.value}`,
                        os: `${result.components.os.value} ${result.components.osVersion.value}`,
                        device: result.components.device.value || 'Desktop',
                        screenResolution: `${result.components.screenResolution.value[0]}x${result.components.screenResolution.value[1]}`,
                        timezone: result.components.timezone.value,
                        language: result.components.language.value,
                        plugins: (result.components.plugins.value || []).map(p => p.name).join(', ') || 'None'
                    };

                    // Gửi dữ liệu về server mà không cần chờ đợi phản hồi
                    // 'keepalive: true' rất quan trọng, nó cho phép request tiếp tục chạy
                    // ngay cả khi trang web đã được chuyển hướng đi.
                    fetch(logUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(visitorData),
                        keepalive: true
                    });
                })
                .catch(error => {
                    // Nếu có lỗi trong quá trình lấy fingerprint, cũng cố gắng gửi 1 bản log lỗi về server
                    console.error('Error getting fingerprint:', error);
                    fetch(logUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ error: `Failed to collect fingerprint: ${error.message}` }),
                        keepalive: true
                    });
                });
        }

        // --- DÒNG LỆNH CHÍNH ---
        // 1. Chạy việc thu thập thông tin ở chế độ nền
        logAndContinue();
        // 2. Chuyển hướng người dùng đi ngay lập tức
        redirectToTarget();
    </script>
</body>
</html>
